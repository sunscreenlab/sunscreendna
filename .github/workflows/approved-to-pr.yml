name: Sunscreen submission processing

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write

jobs:
  process-sunscreen:
    if: >
      github.event.action == 'labeled' &&
      (
        github.event.label.name == 'approved' ||
        github.event.label.name == 'dry-run'
      )
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ----------------------------
      # Optional hardening
      # ----------------------------
      - name: Prevent approved + dry-run together
        if: >
          contains(github.event.issue.labels.*.name, 'approved') &&
          contains(github.event.issue.labels.*.name, 'dry-run')
        run: |
          echo "‚ùå Issue cannot have both 'approved' and 'dry-run' labels."
          exit 1

      - name: Log trigger info
        run: |
          echo "Issue #${{ github.event.issue.number }}"
          echo "Triggered by label: ${{ github.event.label.name }}"
          echo "All labels: ${{ join(github.event.issue.labels.*.name, ', ') }}"

      # ----------------------------
      # Parse submission
      # ----------------------------
      - name: Parse sunscreen submission
        working-directory: .github/scripts
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          npm install
          node parse-sunscreen.js

      # ----------------------------
      # Sanitize + write (or dry run)
      # ----------------------------
      - name: Sanitize and process sunscreen
        id: write_sunscreen
        env:
          SUNSCREEN_DRY_RUN: ${{ contains(github.event.issue.labels.*.name, 'dry-run') }}
        run: node scripts/write-sunscreen-json.js

      # ----------------------------
      # Post sanitizer warnings
      # ----------------------------
      - name: Post sanitizer warnings summary
        if: >
          steps.write_sunscreen.outputs.sanitizer_warnings != '' &&
          (
            contains(github.event.issue.labels.*.name, 'dry-run') ||
            steps.write_sunscreen.outputs.sanitizer_warnings != 'W10='
          )
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WARNINGS_B64: ${{ steps.write_sunscreen.outputs.sanitizer_warnings }}
        run: |
          WARNINGS_JSON=$(echo "$WARNINGS_B64" | base64 --decode)

          BODY="‚ö†Ô∏è **Sanitizer warnings detected**\n\n"

          echo "$WARNINGS_JSON" | jq -c '.[]' | while read -r warning; do
            TYPE=$(echo "$warning" | jq -r '.type')
            case "$TYPE" in
              brand-removed-from-product)
                BODY+="‚Ä¢ Brand name was removed from the product name.\n"
                ;;
              spf-pa-removed-from-product)
                BODY+="‚Ä¢ SPF/PA notation was removed from the product name.\n"
                ;;
              inferred-filter)
                FILTER=$(echo "$warning" | jq -r '.filter')
                BODY+="‚Ä¢ UV filter inferred from ingredients: **$FILTER**.\n"
                ;;
              unknown-uv-filter)
                ING=$(echo "$warning" | jq -r '.ingredient')
                BODY+="‚Ä¢ Possible unknown UV filter detected: **$ING**.\n"
                ;;
              *)
                BODY+="‚Ä¢ ${TYPE}\n"
                ;;
            esac
          done

          BODY+="\nPlease review these warnings before finalizing."

          curl -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -d "$(jq -nc --arg body "$BODY" '{ body: $body }')"

      # ----------------------------
      # Commit (only if approved)
      # ----------------------------
      - name: Commit sunscreens.json
        if: contains(github.event.issue.labels.*.name, 'approved')
        run: |
          git config user.name "sunscreen-bot"
          git config user.email "sunscreen-bot@users.noreply.github.com"
          git add data/sunscreens.json
          git commit -m "Add sunscreen: $SUNSCREEN_ID"
          git push

      # ----------------------------
      # Final acknowledgement
      # ----------------------------
      - name: Post completion comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ contains(github.event.issue.labels.*.name, 'dry-run') }}" == "true" ]]; then
            BODY="üß™ **Dry run complete**\n\nThe submission was sanitized and validated, but no data was written."
          else
            BODY="‚úÖ **Submission approved and added**\n\nThis sunscreen has been added to `sunscreens.json`."
          fi

          curl -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -d "$(jq -nc --arg body "$BODY" '{ body: $body }')"
